# LPO Number Generation Fix

## Issue
When adding an LPO in the LPOs page, the `lpoNumber` was not being:
1. Generated by the backend
2. Stored in Firebase
3. Retrieved and displayed in the table

## Root Cause Found

The `generateSequentialNumber()` function was looking for a field with the name matching the PREFIX (e.g., `item.LPO`), but the actual field names are:
- `lpoNumber` (not `LPO`)
- `invoiceNo` (not `INV`)
- `paymentNo` (not `PAY`)
- `deliveryNo` (not `DLV`)

### Original Code (WRONG)
```typescript
const generateSequentialNumber = async (prefix: string, path: string): Promise<string> => {
  const data = await read(path);
  const items = toArray(data);
  let maxNumber = 0;

  items.forEach((item: Record<string, unknown>) => {
    const numberStr = (item as Record<string, unknown>)[prefix]?.toString() || '';
    // ❌ Looking for item.LPO, but it's actually item.lpoNumber
    const match = numberStr.match(/\d+$/);
    if (match) {
      const num = parseInt(match[0]);
      maxNumber = Math.max(maxNumber, num);
    }
  });

  const newNumber = String(maxNumber + 1).padStart(5, '0');
  return `${prefix}-${new Date().getFullYear()}-${newNumber}`;
};
```

## Solution Applied

Updated the function to use the correct field names:

### Fixed Code (CORRECT)
```typescript
const generateSequentialNumber = async (prefix: string, path: string): Promise<string> => {
  const data = await read(path);
  const items = toArray(data);
  let maxNumber = 0;

  const fieldName = 
    prefix === 'LPO' ? 'lpoNumber' :
    prefix === 'INV' ? 'invoiceNo' :
    prefix === 'PAY' ? 'paymentNo' :
    prefix === 'DLV' ? 'deliveryNo' :
    prefix;

  console.log(`[Sequential] Generating ${prefix} number from ${items.length} existing items`);
  
  items.forEach((item: Record<string, unknown>) => {
    const numberStr = (item as Record<string, unknown>)[fieldName]?.toString() || '';
    // ✅ Now correctly looking for item.lpoNumber
    const match = numberStr.match(/\d+$/);
    if (match) {
      const num = parseInt(match[0]);
      maxNumber = Math.max(maxNumber, num);
    }
  });

  const newNumber = String(maxNumber + 1).padStart(5, '0');
  const result = `${prefix}-${new Date().getFullYear()}-${newNumber}`;
  console.log(`[Sequential] Generated number: ${result} (max was ${maxNumber})`);
  return result;
};
```

## Changes Made

**File**: `backend/src/index.ts`

1. **Fixed `generateSequentialNumber()` function**
   - Added mapping between prefix and field name
   - Now correctly identifies existing sequential numbers
   - Added console logging for debugging

2. **Added logging to LPO POST endpoint**
   - Logs generated lpoNumber
   - Logs LPO data being saved
   - Logs Firebase push response
   - Logs final response to frontend

3. **Added logging to `createLpo` API function**
   - Logs request data
   - Logs response data

## How It Works Now

### Scenario: Creating First LPO
```
1. Frontend calls: createLpo(lpoData)
2. Backend receives POST /api/lpos
3. Backend: generateSequentialNumber('LPO', '/lpos')
   - Reads /lpos from Firebase (empty = 0 existing items)
   - No existing lpoNumbers found
   - Calculates: maxNumber = 0
   - Generates: LPO-2025-00001 ✓
4. Backend stores LPO with: { ...lpoData, lpoNumber: 'LPO-2025-00001' }
5. Frontend receives response with lpoNumber
6. Frontend displays in LPOs table ✓
```

### Scenario: Creating Second LPO
```
1. Frontend calls: createLpo(lpoData)
2. Backend receives POST /api/lpos
3. Backend: generateSequentialNumber('LPO', '/lpos')
   - Reads /lpos from Firebase (1 existing item)
   - Finds existing lpoNumber: LPO-2025-00001
   - Extracts number: 1
   - Calculates: maxNumber = 1
   - Generates: LPO-2025-00002 ✓ (incremented)
4. Backend stores LPO with: { ...lpoData, lpoNumber: 'LPO-2025-00002' }
5. Frontend receives response with lpoNumber
6. Frontend displays in LPOs table ✓
```

## Testing Steps

### Quick Test: Using PowerShell Script

Run the provided test script:
```powershell
.\test-lpo-api.ps1
```

This will:
1. Check backend health
2. Fetch existing LPOs
3. Create a test LPO
4. Verify lpoNumber was generated and stored
5. Show all LPOs with their numbers

### Manual Test: Using Frontend

1. Start backend: `cd backend && npm run dev`
2. Start frontend: `npm run dev`
3. Go to LPOs page
4. Click "Create LPO"
5. Fill in the form and click Save
6. Check browser console (F12) for logs
7. Check backend console for logs
8. Verify LPO appears in table with number like `LPO-2025-00001`

### Manual Test: Using cURL

```bash
# Create an LPO
curl -X POST http://localhost:4000/api/lpos \
  -H "Content-Type: application/json" \
  -d '{
    "companyId": "comp-1",
    "companyName": "Test Company",
    "items": [{"productId": "p1", "productName": "Product 1", "quantity": 1, "unit": "pcs", "unitPrice": 100, "total": 100}],
    "subtotal": 100,
    "vat": 16,
    "totalAmount": 116,
    "date": "2025-11-14",
    "status": "pending"
  }'

# Should return something like:
# {
#   "id": "abc123",
#   "lpoNumber": "LPO-2025-00001",  ✓
#   "companyName": "Test Company",
#   ...
# }
```

## Expected Behavior After Fix

### Creating an LPO
- ✅ Backend generates sequential number
- ✅ Number is stored in Firebase
- ✅ Number is returned in API response
- ✅ Frontend displays number in LPOs table
- ✅ Number format: LPO-2025-00001, LPO-2025-00002, etc.

### Creating Subsequent LPOs
- ✅ Numbers increment: 00001 → 00002 → 00003...
- ✅ No duplicates
- ✅ All numbers stored and retrieved correctly

### Creating Other Entities
- ✅ Invoices: INV-2025-00001, INV-2025-00002...
- ✅ Payments: PAY-2025-00001, PAY-2025-00002...
- ✅ Deliveries: DLV-2025-00001, DLV-2025-00002...

## Console Logs for Debugging

When creating an LPO, you should see:

**Backend Console:**
```
[Sequential] Generating LPO number from 0 existing items
[Sequential] Generated number: LPO-2025-00001 (max was 0)
Generated lpoNumber: LPO-2025-00001
LPO data being saved: { ..., lpoNumber: 'LPO-2025-00001', amountPaid: 0, balance: ..., paymentStatus: 'unpaid' }
Push response: { id: 'abc123' }
Response to send: { id: 'abc123', lpoNumber: 'LPO-2025-00001' }
```

**Browser Console:**
```
Creating LPO with data: { companyId: ..., companyName: ..., ... }
LPO creation result: { id: 'abc123', lpoNumber: 'LPO-2025-00001', companyName: '...', ... }
```

## Files Modified

| File | Changes |
|------|---------|
| `backend/src/index.ts` | Fixed generateSequentialNumber function to use correct field names, added console logging |
| `src/lib/api.ts` | Added console logging to createLpo function |
| Created: `test-lpo-api.ps1` | PowerShell test script for quick verification |

## Status

✅ **FIXED**

The sequential number generation now works correctly for LPOs and all other entities.

## Next Steps

1. Test the LPO creation flow using the test script
2. Verify numbers are being generated and displayed
3. Check backend console for any errors
4. If still not working, share the console logs for further debugging

---

**Note**: If you're still experiencing issues, enable debug mode:
- Browser: Open DevTools (F12) → Console tab
- Backend: Watch npm run dev output for console.log statements

Both will show detailed information about what's happening during LPO creation.
